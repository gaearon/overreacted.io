---
title: Why Do React Elements Have a $$typeof Property?
date: '2018-12-03'
spoiler: It has something to do with security.
cta: 'react'
---

حتما فکر می‌کنید که JSX می‌نویسید:

```jsx
<marquee bgcolor="#ffa7c4">hi</marquee>
```

ولی در حقیقت، یک تابع صدا می‌زنید:

```jsx
React.createElement(
  /* type */ 'marquee',
  /* props */ { bgcolor: '#ffa7c4' },
  /* children */ 'hi'
)
```

که آن تابه به شما یک آبجکت باز می‌گرداند. ما این تابع را *element* ری‌اکت می‌نامیم. این تابع به ری‌اکت می‌گوید که رندر بعدی چیست.  تابع شما درختی از آنها را برمی‌گرداند
```jsx{9}
{
  type: 'marquee',
  props: {
    bgcolor: '#ffa7c4',
    children: 'hi',
  },
  key: null,
  ref: null,
  $$typeof: Symbol.for('react.element'), // 🧐 Who dis
}
```

اگر از ری‌اکت استفاده می‌کنید احتمالا با مفاهیم `type`, `props`, `key`, و `ref` آشنایی دارید. **ولی  `$$typeof` چیست? و چرا یک  `Symbol()` به عنوان مقدار دارد?**

این یکی از مواردی است که برای استفاده از ری‌اکت به دانستن آن *نیاز* ندارید، ولی وقتی می‌دانید به شما احساس خوبی می‌دهد. همچنین یک‌سری نکات در مورد امنیت در این پست وجود دارد که شاید بخواهید بدانید. شاید روزی کتابخانه رابط کاربری خود را نوشتید و تمام اینها به دردتان خورد. به شخصه امیدوارم.

---

قبل از اینکه کتابخانه‌های سمت کاربر رایج شود و حفاظتی پایه‌ای اضافه کنند، برای کد یک نرم‌افزار رایج بود که HTML را بسازد و سپس به DOM وارد کند.

```jsx
const messageEl = document.getElementById('message');
messageEl.innerHTML = '<p>' + message.text + '</p>';
```

کد بالا هیچ مشکلی نداره، به جز زمانی که `message.text` چیزی شبیه به `'<img src onerror="stealYourPassword()">'` باشد. **شما نمی‌هواهد چیزی که غریبه‌ها می‌نویسند در HTML رندر شده نرم‌افزار شما کلمه به کلمه ظاهر شود.**

(یه نکته باحال: اگر فقط رندر سمت کاربر دارید, یک تگ `<script>` در اینجا به شما اجازه اجرای جاوااسکریپت نمی‌دهد. ولی [اجازه ندهید این](https://gomakethings.com/preventing-cross-site-scripting-attacks-when-using-innerhtml-in-vanilla-javascript/) شمار و به درک اشتباهی از امنیت سوق بدهد.)

برای حفاظت از چنین حملاتی, می‌توانید از APIهایی مثل `document.createTextNode()` یا `textContent` که فقط با متن سروکار دارد استفاده کنید. شمار می‌توانید با جایگزین کردن کارکترهایی مثل `<`, `>` در فیلد‌های ورودی که توسط کابر پر می‌شوند از این حملات پیش‌گیری کنید.
هنوز، هزینه اشتباه زیاد است و هر بار به خاطر داشتن تفسیر کردن متن خروجی کاربر عذاب آور است. **به همین دلیل است که کتابخانه‌های مدرن مانند React به صورت پیش فرض از محتوای text برای string فرار می‌کنند:**

```jsx
<p>
  {message.text}
</p>
```

اگر `message.text` یک متن خطرنام با تگ `<img>` یا تک دیگری باشد, به تگ واقعی `<img>` تبدیل نمی‌شود. React از محتوای آن میگذرد بنابراین به جای‌اینکه تگ `<img>` را ببینید فقط مارکاپ آن را می‌بینید.

برای رندر کردن HTML داخل کاموننت ری‌اکت باید `dangerouslySetInnerHTML={{ __html: message.text }}` را بنویسید. **این نکته که نوشتنش ناشیانه است یک ویژگی محسوب می‌شود.** دقیقا به این علت در چشم است که در هنگام بازحوانی کد و ممیزی‌های پایگاه کند شناسایی شود.

---

**آیا به این معنیست کمه ری‌اکت از حملاات تزریقی کاملا در امان است? خیر.** HTML و DOM [تعدای از وریه‌های حمله را](https://github.com/facebook/react/issues/3473#issuecomment-90594748) پیشنهاد می‌دهند که اگر ری‌اکت یا سایر کتابخانه‌ها بخواهند با آنها مقابله کنندیا بسیار دشوار است یا سرعتشان را کاهش می‌دهد. بیشتر بردار‌های حمله باقی مانده خصیصه‌ها را دربر می‌گیرند.
 برای مثال اگر `<a href={user.website}>` را رندر کنید,از آن دسته از کاربرانی که وب‌سایتشان `'javascript: stealYourPassword()'` است آگاه باشید. انتقال به شکل (...) برای داده‌های کاربر مانند `<div {...userData}>` هم می‌تواند خطرناک باشد ولی نادر است.

ری‌اکت [می‌تواند](https://github.com/facebook/react/issues/10506) در طول زمان حفاظت بیشتری را فراهم کند ولی بیشتر موارد این مسله مشکل سرور به حساب می‌آید که [باید](https://github.com/facebook/react/issues/3473#issuecomment-91327040) در هر صورت برطرف گردد.

هنوز، جلوگیری از وارد کردن محتوای متن در قدم اول می‌تواند بسیاری از حملات بالقوه را کاهش دهد. خوب نیست که بدونیم چنین کدهایی امن هستند یا نه ؟

```jsx
// Escaped automatically
<p>
  {message.text}
</p>
```

**خب, همیشه هم جواب مثبت نیست.**  به همین علت است که `$$typeof` وارد میدان می‌شود.

---

المنت‌های ری‌اکت به شکل آبجکت دیزاین شده‌اند:

```jsx
{
  type: 'marquee',
  props: {
    bgcolor: '#ffa7c4',
    children: 'hi',
  },
  key: null,
  ref: null,
  $$typeof: Symbol.for('react.element'),
}
```

در حالی که شما به شکل نرمال با استفاده از `React.createElement()` ایجادشان می‌کنید، نیازی به این تابع ندارد.
موارد صادقی در ری‌اکت وجود دارد که از آبجکت‌های ساده پشتیبانی می‌کند درست مثل چیزی که در بالا انجام دادم. البته شما نمی‌خواهید که آنها را اینگ.نه بنویسید - ولی [این میتواند](https://github.com/facebook/react/pull/3583#issuecomment-90296667) برای بهبود کامپایلر، ارسال (پاس دادن) المت‌ها به ورکر‌ها یا جدا کردن JSX از پکیج ری‌اکت مفید باشد.

گرچه, **سرور سوراخی دارد که به کاربر اجازه میدهد هر آبجکتی را به شکل خودسرانه ذخیره کند** در حالی که سمت کاربر فقط به رشته نیاز دارد میتواند مشکل ایجاد کند:

```jsx{2-10,15}
// Server could have a hole that lets user store JSON
let expectedTextButGotJSON = {
  type: 'div',
  props: {
    dangerouslySetInnerHTML: {
      __html: '/* put your exploit here */'
    },
  },
  // ...
};
let message = { text: expectedTextButGotJSON };

// Dangerous in React 0.13
<p>
  {message.text}
</p>
```

در این مورد ری‌اکت ۰.۱۳ میتواند نسبت به حملات XSS [بی دفاع](http://danlec.com/blog/xss-via-a-spoofed-react-element) باشد. برای شفافیت دوباره، **tاین حملات نیاز بستگی به سوراخی در سرور دارد**. هنوز, ری‌اکت می‌تواند کارهای بهتری برای حفاظت علیه این حملات انجام دهد. و با شروع ری‌اکت ۰.۱۴ ,این کار را می‌کند.

این تعمیری که در ری‌امت ۰.۱۴ انجام شد این بود که [تمام المان های ری‌اکت را با یک نشان(Symbol) نشانه گذاری کنیم](https://github.com/facebook/react/pull/4832):

```jsx{9}
{
  type: 'marquee',
  props: {
    bgcolor: '#ffa7c4',
    children: 'hi',
  },
  key: null,
  ref: null,
  $$typeof: Symbol.for('react.element'),
}
```

این کار عملیست چون شما نمی‌تواند به راحتی `Symbol` در JSON قرار دهید.**بنابراین حتی اگر سرور سوراخی داشته باشد و به جای رشته JSON برگرداند آن JSON نمی‌تواند `Symbol.for('react.element')` داشته باشد.** ری‌اکت `element.$$typeof` را چک می‌کند، و اگر این نشان را نداشته باشد از پردازش آن خودداری می‌کند.

چیز خوبی که در مورد خصوصا`Symbol.for()` وجود دارد این است که **Symbolها در بین محیطی مثل iframes و workers گلوبال هستند.** بنابراین این تعمیر از ارسال المنت‌های مورد اعتماد بین قسمت‌های مختلف نرم‌افزار حتی در شرایط سخت جلوگیری نمی‌کند. مشابها، حتی اگر چندین کپی از ری‌اکت در یک پیج وجود داشته باشد، همه آنها نسبت به مقدار صحیح `$$typeof` متفق القول هستند.

---

در مورد مرورگری که از Symbolها [پشتیبانی نمی‌کند](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol#Browser_compatibility) چه?

افسوس,آنها از این حفاظت بهرمند نمی‌شوند. ری‌اکت همچنان فیلد `$$typeof` در المان نگه می‌دارد, ولی [به عنوان عدد](https://github.com/facebook/react/blob/8482cbe22d1a421b73db602e1f470c632b09f693/packages/shared/ReactSymbols.js#L14-L16) — `0xeac7`.

چرا این عدد؟  `0xeac7` چ.ن شبیه به “React” است.
